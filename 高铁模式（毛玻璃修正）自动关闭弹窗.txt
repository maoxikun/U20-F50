<script>
(() => {
    const modal = document.createElement('div');
    modal.id = 'glass-modal';
    modal.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 9999;
        display: none;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        background: rgba(255, 255, 255, 0);
        backdrop-filter: blur(12px) saturate(180%);
        -webkit-backdrop-filter: blur(12px) saturate(180%);
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        transition: all 0.3s ease-out;
    `;
    modal.innerHTML = `
        <div style="width:100%; max-width:720px; height:80vh;
                    background:rgba(255,255,255,.30);
                    border:1px solid rgba(255,255,255,.40);
                    border-radius:12px; overflow:hidden;
                    box-shadow:0 8px 32px rgba(0,0,0,.12);">
            <div style="padding:12px 16px; background:rgba(40,40,40,.60);
                        color:#ffffff; font-size:22px; font-weight:bold;
                        display:flex; justify-content:space-between; align-items:center;">
             <span>æ‰§è¡Œæ—¥å¿—</span>
                <span id="autoCloseHint" style="font-size:14px; color:#ccc; display:none;">3s</span>
            </div>
            <textarea id="logText" readonly
                      style="width:100%; height:calc(100% - 56px);
                             border:none; resize:none; padding:14px 16px;
                             font-family:'Courier New',monospace;
                             font-size:2rem; line-height:2;
                             color:#000; background:transparent;">
            </textarea>
        </div>
    `;
    document.body.appendChild(modal);
    const logText = modal.querySelector('#logText');
    const autoCloseHint = modal.querySelector('#autoCloseHint');
    const addLog  = msg => { logText.value += `[${new Date().toLocaleTimeString()}] ${msg}\n`; logText.scrollTop = logText.scrollHeight; };
    const showLog = () => (modal.style.display = 'flex');
    const hideLog = () => (modal.style.display = 'none');
    /* ========== æ–‡ä»¶æŒä¹…åŒ– ========== */
    const STATE_FILE = '/sdcard/.highspeed_mode_state';
    const runRoot = cmd => runShellWithRoot(cmd);
    const readState = async () => {
        try {
            const r = await runRoot(`cat ${STATE_FILE}`);
            return r?.success && r.content.trim() === '1';
        } catch { return false; }
    };
    const saveState = async on => {
        await runRoot(`echo ${on ? 1 : 0} > ${STATE_FILE}`);
    };
    const cmdOn = [
        ["setprop persist.vendor.radio.rat_acq_order 3,2,1",           "è®¾å®šæœç½‘é¡ºåºä¸º 5G SA â†’ 5G NSA â†’ 4G LTEï¼Œé«˜é“é«˜é€Ÿè¡Œé©¶æ—¶ä¼˜å…ˆæ‰¾ 5G åŸºç«™ï¼Œå‡å°‘ 3-5 ç§’æœç½‘ç­‰å¾…"],
        ["setprop persist.vendor.radio.5g_mode_preference 3",          "å¼ºåˆ¶å¯ç”¨ 5G SA+NSA åŒæ¨¡ï¼Œé¿å…åªè¿ž NSA å¯¼è‡´ä¸Šè¡Œé€ŸçŽ‡ä½Žï¼Œæå‡ 20-30% ä¸Šä¼ ä½“éªŒ"],
        ["setprop persist.vendor.radio.5g_mode_priority 3",            "æŠŠ 5G è®¾ä¸ºæœ€é«˜ä¼˜å…ˆçº§ï¼Œå¼±ä¿¡å·ä¹Ÿå…ˆé©»ç•™ 5Gï¼Œä¿è¯å¤§å¸¦å®½ä¸æ–­æ¡£"],
        ["setprop persist.vendor.radio.5g_mode_fallback 2",            "5G æ¶ˆå¤±åŽ 0.5 ç§’å†…å›žè½ 4Gï¼Œä¸æŽ‰çº¿ã€ä¸æ–­è§†é¢‘ã€ä¸æ–­æ¸¸æˆ"],
        ["setprop persist.vendor.network_mode 20",                     "é”å®š NR+LTEï¼Œå½»åº•å±è”½ 3G/2Gï¼Œå‡å°‘ 1-2 ç§’åˆ¶å¼åˆ‡æ¢å»¶è¿Ÿ"],
        ["setprop persist.vendor.radio.meas_period 200",               "æŠŠé‚»åŒºæµ‹é‡å‘¨æœŸç¼©åˆ° 200 msï¼Œ350 km/h é«˜é“ä»èƒ½æ¯ç§’æ£€æµ‹ 5 ä¸ªæ–°å°åŒºï¼Œæå‰å‡†å¤‡åˆ‡æ¢"],
        ["setprop persist.vendor.radio.a3_offset 0",                   "å°†åˆ‡æ¢é—¨é™è®¾ä¸º 0 dBï¼Œæå‰ 2-3 dB è§¦å‘åˆ‡æ¢ï¼Œé˜²æ­¢å¼±ä¿¡å·å¡é¡¿"],
        ["setprop persist.vendor.radio.ttt 20",                        "è§¦å‘æ—¶é—´åŽ‹åˆ° 20 msï¼Œæ¯”é»˜è®¤ 320 ms å¿« 16 å€ï¼Œçž¬é—´å®Œæˆå°åŒºåˆ‡æ¢"],
        ["setprop persist.vendor.radio.hysteresis 1",                  "è¿Ÿæ»žä»… 1 dBï¼Œæ—¢é˜²ä¹’ä¹“åˆ‡æ¢åˆä¿æŒçµæ•ï¼Œæ¯”é»˜è®¤ 4 dB æ›´æ¿€è¿›"],
        ["setprop persist.vendor.radio.rlf_rcvr_timer 500",            "æŽ‰çº¿åŽ 500 ms å†…è‡ªåŠ¨é‡è¿žï¼Œç”¨æˆ·å‡ ä¹Žæ„ŸçŸ¥ä¸åˆ°ä¸­æ–­ï¼Œè§†é¢‘/æ¸¸æˆä¸æŽ‰å¸§"],
        ["setprop persist.vendor.radio.rlf_wait_time 500",             "é‡è¿žçª—å£åŒæ · 500 msï¼Œç¡®ä¿å¤±è´¥åŽ 0.5 ç§’å®Œæˆå…¨é¢‘æ®µé‡æœ"],
        ["setprop persist.vendor.radio.force_reacquire 1",             "å¼ºåˆ¶ç«‹å³é‡æœå…¨ç½‘ï¼Œè·³è¿‡ç­‰å¾…ï¼Œå‡å°‘ 3-4 ç§’æ–­ç½‘æ—¶é—´"],
        ["echo 0 > /sys/module/lpm_levels/parameters/sleep_disabled",  "å…³é—­ CPU/åŸºå¸¦çœç”µä¼‘çœ ï¼Œé˜²æ­¢ä¼‘çœ å¯¼è‡´çš„ 100-200 ms å»¶è¿Ÿå’ŒæŽ‰çº¿"],
        ["echo 0 > /sys/class/net/wwan0/qos/cdrx_enable",              "ç¦ç”¨ CDRXï¼Œå–æ¶ˆå‘¨æœŸæ€§æŽ¥æ”¶çª—å£å…³é—­ï¼Œå»¶è¿Ÿé™ä½Ž 20-40 ms"],
        ["echo 0 > /sys/class/net/wwan0/qos/drx_enable",               "ç¦ç”¨ DRXï¼Œé¿å…é”™è¿‡ä¸‹è¡Œæ•°æ®åŒ…ï¼Œä¸¢åŒ…çŽ‡é™ä½Ž 30-50%"],
        ["echo 0 > /sys/kernel/debug/msm_vidc/enable_cdrx",            "å…³é—­è§†é¢‘ CDRXï¼Œç›´æ’­/ä¼šè®®å¡é¡¿æ¬¡æ•°å‡å°‘ 40%"],
        ["echo 0 > /sys/kernel/debug/msm_vidc/enable_drx",             "å…³é—­è§†é¢‘ DRXï¼Œä¿æŒè§†é¢‘ç çŽ‡ç¨³å®šï¼Œæ¸…æ™°åº¦æ›´æŒä¹…"],
        ["echo 0 > /sys/kernel/debug/scsc_wlan/mib/set/dyn_features_disable", "å…³é—­ WLAN åŠ¨æ€çœç”µï¼Œé˜²æ­¢èœ‚çªä¸Ž Wi-Fi æŠ¢ç”µå¯¼è‡´ä¿¡å·ä¸ç¨³"],
        ["echo 0 > /sys/module/wlan/parameters/fw_fast_path_mode",     "åœç”¨ WLAN å¿«é€Ÿè·¯å¾„ï¼Œç¡®ä¿èœ‚çªæ•°æ®å§‹ç»ˆä¼˜å…ˆè½¬å‘"],
        ["echo 0 > /sys/devices/platform/soc/18800000.qcom,pcie/pcie_suspend_disable", "ç¦ç”¨ PCIe æŒ‚èµ·ï¼Œé˜²æ­¢åŸºå¸¦å¡æ­»ï¼Œä¿¡å· 0 æŽ‰çº¿"],
        ["setprop persist.vendor.radio.nr_lock_band 78,79",            "é”å®š 5G é«˜é“ä¸“ç½‘é¢‘æ®µ B78/B79ï¼Œé€ŸçŽ‡æ¯”å…¬ç½‘é«˜ 30-50%"],
        ["setprop persist.vendor.radio.lte_lock_band 3,8,39,40,41",    "é”å®š LTE é«˜é“ä¸“ç½‘é¢‘æ®µ B3/B8/B39/B40/B41ï¼Œä¸‹è¡Œé€ŸçŽ‡ç¨³å®šåœ¨ 100 Mbps ä»¥ä¸Š"],
        ["svc data disable && sleep 1 && svc data enable",             "é‡å¯æ•°æ®è¿žæŽ¥ï¼Œæ‰€æœ‰å‚æ•°ç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯æ‰‹æœº"]
    ];
    const cmdOff = cmdOn.map(([c, d]) => [
        c.replace(/=\d+|=\d+,\d+|> 0/g, m => m.includes('>') ? '> 1' : '=0'),
        "â†©ï¸ æ¢å¤é»˜è®¤ï¼š" + d.replace(/^.*?ï¼š/, "")
    ]);

    let busy = false;
    let autoCloseTimer = null;
    let countdownInterval = null;
    const toggle = async () => {
        if (busy) return;
        busy = true;
        const enabled = await readState();
        const todo = enabled ? cmdOff : cmdOn;
        logText.value = '';
        showLog();
        if (autoCloseTimer) {
            clearTimeout(autoCloseTimer);
            autoCloseTimer = null;
        }
        if (countdownInterval) {
            clearInterval(countdownInterval);
            countdownInterval = null;
        }
        autoCloseHint.style.display = 'none';
        addLog(enabled ? "â›”ï¸ æ­£åœ¨å…³é—­é«˜é“æ¨¡å¼..." : "âœ…ï¸ æ­£åœ¨å¼€å¯é«˜é“æ¨¡å¼...");
        for (const [cmd, desc] of todo) {
            try {
                const res = await runRoot(cmd);
                addLog(res?.success ? `â˜‘ï¸ ${desc}` : `âŒ ${desc} å¤±è´¥`);
            } catch {
                addLog(`â“ ${desc} å¼‚å¸¸`);
            }
            await new Promise(r => setTimeout(r, 120));
        }
        await saveState(!enabled);
        btn.style.background = !enabled ? "var(--dark-btn-color-active, #4caf50)" : "var(--dark-btn-color, #424242)";
        busy = false;
        addLog(enabled ? "âŒ ðŸš‚ é«˜é“æ¨¡å¼å·²å…³é—­" : "âœ…ï¸ ðŸš… é«˜é“æ¨¡å¼å·²å¯åŠ¨");
        autoCloseHint.style.display = 'inline';
        let secondsLeft = 3;
        countdownInterval = setInterval(() => {
            secondsLeft--;
            autoCloseHint.textContent = `${secondsLeft}s`;
            if (secondsLeft <= 0) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }, 1000);
        autoCloseTimer = setTimeout(() => {
            if (modal.style.display === 'flex') {
                hideLog();
            }
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }, 3000);
    };
    const btn = document.createElement("button");
    btn.textContent = "é«˜é“æ¨¡å¼";
    btn.onclick = toggle;
    const tryInsert = setInterval(() => {
        const container = document.querySelector(".actions-buttons");
        if (container) {
            clearInterval(tryInsert);
            container.appendChild(btn);
            readState().then(on => {
                btn.style.background = on ? "var(--dark-btn-color-active, #FFFFFF)" : "var(--dark-btn-color, #424242)";
            });
        }
    }, 200);
})();
</script>