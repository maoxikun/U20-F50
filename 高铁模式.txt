<script>
(() => {
    /* ========== 1. é€æ˜ç£¨ç ‚å¼¹çª—ï¼ˆä¸å˜ï¼‰ ========== */
    const modal = document.createElement('div');
    modal.id = 'highspeed-log-modal';
    modal.style.cssText = `
        position:fixed; inset:0; z-index:9999;
        display:none; align-items:flex-start; justify-content:center;
        padding:20px;
        background:rgba(255,255,255,0);
        backdrop-filter:blur(6px) saturate(120%);
        -webkit-backdrop-filter:blur(6px) saturate(120%);
    `;
    modal.innerHTML = `
        <div style="width:100%; max-width:720px; height:80vh;
                    background:rgba(255,255,255,.30);
                    border:1px solid rgba(255,255,255,.40);
                    border-radius:12px; overflow:hidden;
                    box-shadow:0 8px 32px rgba(0,0,0,.12);">
            <div style="padding:12px 16px; background:rgba(40,40,40,.60);
                        color:#fff; font-size:22px; font-weight:bold;
                        display:flex; justify-content:space-between; align-items:center;">
                é«˜é“æ¨¡å¼æ‰§è¡Œæ—¥å¿—
                <button id="closeLogBtn" style="border:none; background:none;
                         color:#e0e0e0; font-size:24px; cursor:pointer;">âœ•</button>
            </div>
            <textarea id="logText" readonly
                      style="width:100%; height:calc(100% - 56px);
                             border:none; resize:none; padding:14px 16px;
                             font-family:'Courier New',monospace;
                             font-size:2rem; line-height:2;
                             color:#000; background:transparent;">
            </textarea>
        </div>
    `;
    document.body.appendChild(modal);

    const logText = modal.querySelector('#logText');
    const addLog  = msg => { logText.value += `[${new Date().toLocaleTimeString()}] ${msg}\n`; logText.scrollTop = logText.scrollHeight; };
    const showLog = () => (modal.style.display = 'flex');
    const hideLog = () => (modal.style.display = 'none');
    modal.querySelector('#closeLogBtn').onclick = hideLog;
    modal.onclick = e => { if (e.target === modal) hideLog(); };

    /* ========== 2. æ–‡ä»¶æŒä¹…åŒ–ï¼ˆä¸å˜ï¼‰ ========== */
    const STATE_FILE = '/sdcard/.highspeed_mode_state';
    const runRoot = cmd => runShellWithRoot(cmd);
    const readState = async () => {
        try {
            const r = await runRoot(`cat ${STATE_FILE}`);
            return r?.success && r.content.trim() === '1';
        } catch { return false; }
    };
    const saveState = async on => {
        await runRoot(`echo ${on ? 1 : 0} > ${STATE_FILE}`);
    };

    /* ========== 3. æŒ‡ä»¤é›†ï¼ˆä¸å˜ï¼‰ ========== */
    const cmdOn = [
        ["setprop persist.vendor.radio.rat_acq_order 3,2,1",           "è®¾å®šæœç½‘é¡ºåºä¸º 5G SA â†’ 5G NSA â†’ 4G LTEï¼Œé«˜é“é«˜é€Ÿè¡Œé©¶æ—¶ä¼˜å…ˆæ‰¾ 5G åŸºç«™ï¼Œå‡å°‘ 3-5 ç§’æœç½‘ç­‰å¾…"],
        ["setprop persist.vendor.radio.5g_mode_preference 3",          "å¼ºåˆ¶å¯ç”¨ 5G SA+NSA åŒæ¨¡ï¼Œé¿å…åªè¿ NSA å¯¼è‡´ä¸Šè¡Œé€Ÿç‡ä½ï¼Œæå‡ 20-30% ä¸Šä¼ ä½“éªŒ"],
        ["setprop persist.vendor.radio.5g_mode_priority 3",            "æŠŠ 5G è®¾ä¸ºæœ€é«˜ä¼˜å…ˆçº§ï¼Œå¼±ä¿¡å·ä¹Ÿå…ˆé©»ç•™ 5Gï¼Œä¿è¯å¤§å¸¦å®½ä¸æ–­æ¡£"],
        ["setprop persist.vendor.radio.5g_mode_fallback 2",            "5G æ¶ˆå¤±å 0.5 ç§’å†…å›è½ 4Gï¼Œä¸æ‰çº¿ã€ä¸æ–­è§†é¢‘ã€ä¸æ–­æ¸¸æˆ"],
        ["setprop persist.vendor.network_mode 20",                     "é”å®š NR+LTEï¼Œå½»åº•å±è”½ 3G/2Gï¼Œå‡å°‘ 1-2 ç§’åˆ¶å¼åˆ‡æ¢å»¶è¿Ÿ"],
        ["setprop persist.vendor.radio.meas_period 200",               "æŠŠé‚»åŒºæµ‹é‡å‘¨æœŸç¼©åˆ° 200 msï¼Œ350 km/h é«˜é“ä»èƒ½æ¯ç§’æ£€æµ‹ 5 ä¸ªæ–°å°åŒºï¼Œæå‰å‡†å¤‡åˆ‡æ¢"],
        ["setprop persist.vendor.radio.a3_offset 0",                   "å°†åˆ‡æ¢é—¨é™è®¾ä¸º 0 dBï¼Œæå‰ 2-3 dB è§¦å‘åˆ‡æ¢ï¼Œé˜²æ­¢å¼±ä¿¡å·å¡é¡¿"],
        ["setprop persist.vendor.radio.ttt 20",                        "è§¦å‘æ—¶é—´å‹åˆ° 20 msï¼Œæ¯”é»˜è®¤ 320 ms å¿« 16 å€ï¼Œç¬é—´å®Œæˆå°åŒºåˆ‡æ¢"],
        ["setprop persist.vendor.radio.hysteresis 1",                  "è¿Ÿæ»ä»… 1 dBï¼Œæ—¢é˜²ä¹’ä¹“åˆ‡æ¢åˆä¿æŒçµæ•ï¼Œæ¯”é»˜è®¤ 4 dB æ›´æ¿€è¿›"],
        ["setprop persist.vendor.radio.rlf_rcvr_timer 500",            "æ‰çº¿å 500 ms å†…è‡ªåŠ¨é‡è¿ï¼Œç”¨æˆ·å‡ ä¹æ„ŸçŸ¥ä¸åˆ°ä¸­æ–­ï¼Œè§†é¢‘/æ¸¸æˆä¸æ‰å¸§"],
        ["setprop persist.vendor.radio.rlf_wait_time 500",             "é‡è¿çª—å£åŒæ · 500 msï¼Œç¡®ä¿å¤±è´¥å 0.5 ç§’å®Œæˆå…¨é¢‘æ®µé‡æœ"],
        ["setprop persist.vendor.radio.force_reacquire 1",             "å¼ºåˆ¶ç«‹å³é‡æœå…¨ç½‘ï¼Œè·³è¿‡ç­‰å¾…ï¼Œå‡å°‘ 3-4 ç§’æ–­ç½‘æ—¶é—´"],
        ["echo 0 > /sys/module/lpm_levels/parameters/sleep_disabled",  "å…³é—­ CPU/åŸºå¸¦çœç”µä¼‘çœ ï¼Œé˜²æ­¢ä¼‘çœ å¯¼è‡´çš„ 100-200 ms å»¶è¿Ÿå’Œæ‰çº¿"],
        ["echo 0 > /sys/class/net/wwan0/qos/cdrx_enable",              "ç¦ç”¨ CDRXï¼Œå–æ¶ˆå‘¨æœŸæ€§æ¥æ”¶çª—å£å…³é—­ï¼Œå»¶è¿Ÿé™ä½ 20-40 ms"],
        ["echo 0 > /sys/class/net/wwan0/qos/drx_enable",               "ç¦ç”¨ DRXï¼Œé¿å…é”™è¿‡ä¸‹è¡Œæ•°æ®åŒ…ï¼Œä¸¢åŒ…ç‡é™ä½ 30-50%"],
        ["echo 0 > /sys/kernel/debug/msm_vidc/enable_cdrx",            "å…³é—­è§†é¢‘ CDRXï¼Œç›´æ’­/ä¼šè®®å¡é¡¿æ¬¡æ•°å‡å°‘ 40%"],
        ["echo 0 > /sys/kernel/debug/msm_vidc/enable_drx",             "å…³é—­è§†é¢‘ DRXï¼Œä¿æŒè§†é¢‘ç ç‡ç¨³å®šï¼Œæ¸…æ™°åº¦æ›´æŒä¹…"],
        ["echo 0 > /sys/kernel/debug/scsc_wlan/mib/set/dyn_features_disable", "å…³é—­ WLAN åŠ¨æ€çœç”µï¼Œé˜²æ­¢èœ‚çªä¸ Wi-Fi æŠ¢ç”µå¯¼è‡´ä¿¡å·ä¸ç¨³"],
        ["echo 0 > /sys/module/wlan/parameters/fw_fast_path_mode",     "åœç”¨ WLAN å¿«é€Ÿè·¯å¾„ï¼Œç¡®ä¿èœ‚çªæ•°æ®å§‹ç»ˆä¼˜å…ˆè½¬å‘"],
        ["echo 0 > /sys/devices/platform/soc/18800000.qcom,pcie/pcie_suspend_disable", "ç¦ç”¨ PCIe æŒ‚èµ·ï¼Œé˜²æ­¢åŸºå¸¦å¡æ­»ï¼Œä¿¡å· 0 æ‰çº¿"],
        ["setprop persist.vendor.radio.nr_lock_band 78,79",            "é”å®š 5G é«˜é“ä¸“ç½‘é¢‘æ®µ B78/B79ï¼Œé€Ÿç‡æ¯”å…¬ç½‘é«˜ 30-50%"],
        ["setprop persist.vendor.radio.lte_lock_band 3,8,39,40,41",    "é”å®š LTE é«˜é“ä¸“ç½‘é¢‘æ®µ B3/B8/B39/B40/B41ï¼Œä¸‹è¡Œé€Ÿç‡ç¨³å®šåœ¨ 100 Mbps ä»¥ä¸Š"],
        ["svc data disable && sleep 1 && svc data enable",             "é‡å¯æ•°æ®è¿æ¥ï¼Œæ‰€æœ‰å‚æ•°ç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯æ‰‹æœº"]
    ];
    const cmdOff = cmdOn.map(([c, d]) => [
        c.replace(/=\d+|=\d+,\d+|> 0/g, m => m.includes('>') ? '> 1' : '=0'),
        "âª æ¢å¤é»˜è®¤ï¼š" + d.replace(/^.*?ï¼š/, "")
    ]);

    /* ========== 4. ä¸»å¼€å…³é€»è¾‘ ========== */
    let busy = false;
    const toggle = async () => {
        if (busy) return;
        busy = true;
        const enabled = await readState();
        const todo = enabled ? cmdOff : cmdOn;

        logText.value = '';
        showLog();
        addLog(enabled ? "ğŸ”„ æ­£åœ¨å…³é—­é«˜é“æ¨¡å¼..." : "ğŸ”„ æ­£åœ¨å¼€å¯é«˜é“æ¨¡å¼...");

        for (const [cmd, desc] of todo) {
            try {
                const res = await runRoot(cmd);
                addLog(res?.success ? `âœ… ${desc}` : `âŒ ${desc} å¤±è´¥`);
            } catch {
                addLog(`âŒ ${desc} å¼‚å¸¸`);
            }
            await new Promise(r => setTimeout(r, 120));
        }
        await saveState(!enabled);
        btn.style.background = !enabled ? "var(--dark-btn-color-active, #4caf50)" : "var(--dark-btn-color, #424242)";
        busy = false;
        addLog(enabled ? "ğŸš‚ é«˜é“æ¨¡å¼å·²å…³é—­" : "ğŸš„ é«˜é“æ¨¡å¼å·²å¯åŠ¨");
    };

    /* ========== 5. åˆ›å»ºæŒ‰é’®ï¼ˆåªæ”¹é¢œè‰²ï¼Œä¸æ”¹å¤§å°/è¾¹è·ï¼‰ ========== */
    const btn = document.createElement("button");
    btn.textContent = "é«˜é“æ¨¡å¼";
    btn.onclick = toggle;

    /* å®šæ—¶æ’å…¥æŒ‰é’®å¹¶è®¾åˆå§‹é¢œè‰² */
    const tryInsert = setInterval(() => {
        const container = document.querySelector(".actions-buttons");
        if (container) {
            clearInterval(tryInsert);
            container.appendChild(btn);
            readState().then(on => {
                btn.style.background = on ? "var(--dark-btn-color-active, #4caf50)" : "var(--dark-btn-color, #424242)";
            });
        }
    }, 200);
})();
</script>